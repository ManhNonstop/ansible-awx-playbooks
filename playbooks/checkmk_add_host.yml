---
##################################################
# PLAY 1: Create hosts via REST API
##################################################
- name: Add hosts to Checkmk via REST API
  hosts: all
  gather_facts: yes
  become: no

  vars:
    checkmk_api: "{{ checkmk_url }}/{{ checkmk_site }}/check_mk/api/1.0"
    checkmk_hostname: >-
      {{ inventory_hostname
         | lower
         | regex_replace('[^a-zA-Z0-9_.-]', '_') }}
    checkmk_ip: "{{ ansible_host | default(ansible_default_ipv4.address) }}"

  tasks:
    - name: Debug mapping
      debug:
        msg:
          awx_inventory_hostname: "{{ inventory_hostname }}"
          checkmk_hostname: "{{ checkmk_hostname }}"
          ip: "{{ checkmk_ip }}"

    - name: Check if host exists in Checkmk
      uri:
        url: "{{ checkmk_api }}/objects/host_config/{{ checkmk_hostname }}"
        method: GET
        user: "{{ checkmk_user }}"
        password: "{{ checkmk_secret }}"
        force_basic_auth: yes
        validate_certs: no
        headers:
          Accept: application/json
        status_code: [200, 404]
      register: checkmk_host_check

    - name: Create host in Checkmk if missing
      uri:
        url: "{{ checkmk_api }}/domain-types/host_config/collections/all"
        method: POST
        user: "{{ checkmk_user }}"
        password: "{{ checkmk_secret }}"
        force_basic_auth: yes
        validate_certs: no
        headers:
          Accept: application/json
          Content-Type: application/json
        body_format: json
        body:
          host_name: "{{ checkmk_hostname }}"
          folder: "{{ checkmk_folder }}"
          attributes:
            ipaddress: "{{ checkmk_ip }}"
            tag_agent: "cmk-agent"
      when: checkmk_host_check.status == 404


##################################################
# PLAY 2: Auto-discover + Accept + Activate (SSH)
##################################################
- name: Discover services and activate via automation command
  hosts: all
  gather_facts: no
  become: no

  vars:
    checkmk_hostname: >-
      {{ inventory_hostname
         | lower
         | regex_replace('[^a-zA-Z0-9_.-]', '_') }}

  tasks:
    - name: Run service auto-discovery (accept all services) if host exists
      ansible.builtin.shell: |
        su - {{ checkmk_site }} -c \
        "cmk --automation autodiscovery --hostname {{ checkmk_hostname }} --mode full || true"
      delegate_to: "{{ checkmk_server }}"
      register: service_discovery
      changed_when: "'pending' in service_discovery.stdout or service_discovery.rc == 0"

    - name: Skip if no pending changes
      debug:
        msg: "No service changes pending for {{ checkmk_hostname }}"
      when: service_discovery.stdout == "" or service_discovery.stdout is not defined

    - name: Activate Checkmk changes (once)
      ansible.builtin.shell: |
        su - {{ checkmk_site }} -c "cmk -R"
      delegate_to: "{{ checkmk_server }}"
      run_once: true
      changed_when: true
