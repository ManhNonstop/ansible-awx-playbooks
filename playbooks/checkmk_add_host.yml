- name: Checkmk Management Playbook
  hosts: all
  gather_facts: no

  vars:
    checkmk_api: "{{ checkmk_url }}/{{ checkmk_site }}/check_mk/api/1.0"
    checkmk_hostname: "{{ inventory_hostname | lower | regex_replace('[^a-zA-Z0-9_.-]', '_') }}"
    checkmk_auth_header: "Basic {{ (checkmk_user ~ ':' ~ checkmk_secret) | b64encode }}"

  tasks:
    # 1️⃣ CHECK HOST
    - name: Check if host already exists
      uri:
        url: "{{ checkmk_api }}/objects/host_config/{{ checkmk_hostname }}"
        method: GET
        headers:
          Authorization: "{{ checkmk_auth_header }}"
          Accept: application/json
        status_code: [200, 404]
        validate_certs: no
      register: host_check

    # 2️⃣ CREATE HOST (NẾU CHƯA CÓ)
    - name: Create host if missing
      uri:
        url: "{{ checkmk_api }}/domain-types/host_config/collections/all"
        method: POST
        headers:
          Authorization: "{{ checkmk_auth_header }}"
          Accept: application/json
          Content-Type: application/json
        body_format: json
        body:
          host_name: "{{ checkmk_hostname }}"
          folder: "{{ checkmk_folder | default('/') }}"
          attributes:
            ipaddress: "{{ ansible_host | default(inventory_hostname) }}"
        validate_certs: no
      when: host_check.status == 404

    # 3️⃣ SERVICE DISCOVERY + ACCEPT ALL (CLI – CHUẨN)
    - name: Service discovery and accept all services via CLI
      ansible.builtin.shell: |
        su - {{ checkmk_site }} -c "cmk -II {{ checkmk_hostname }}"
      delegate_to: "{{ checkmk_server }}"
      become: yes
      register: discovery_cli
      changed_when: "'Added' in discovery_cli.stdout or 'changed' in discovery_cli.stdout"

    # 4️⃣ ACTIVATE CHANGES (CLI – ỔN ĐỊNH NHẤT)
    - name: Activate changes via CLI
      ansible.builtin.shell: |
        su - {{ checkmk_site }} -c "cmk -R"
      delegate_to: "{{ checkmk_server }}"
      become: yes
      run_once: true
