- name: Checkmk Management Playbook
  hosts: all
  gather_facts: no
  vars:
    checkmk_api: "{{ checkmk_url }}/{{ checkmk_site }}/check_mk/api/1.0"
    checkmk_hostname: "{{ inventory_hostname | lower | regex_replace('[^a-zA-Z0-9_.-]', '_') }}"
    auth_header: "Bearer automation U3!#*s1IlfZjPCXB"

  tasks:
    # BƯỚC 1: KIỂM TRA HOST TỒN TẠI CHƯA
    - name: Check if host already exists
      uri:
        url: "{{ checkmk_api }}/objects/host_config/{{ checkmk_hostname }}"
        method: GET
        headers:
          Authorization: "{{ auth_header }}"
          Accept: application/json
        status_code: [200, 404]
      register: host_check

    # BƯỚC 2: CHỈ TẠO HOST NẾU CHƯA CÓ (STATUS 404)
    - name: Create host if missing
      uri:
        url: "{{ checkmk_api }}/domain-types/host_config/collections/all"
        method: POST
        headers:
          Authorization: "{{ auth_header }}"
          Accept: application/json
          Content-Type: application/json
        body_format: json
        body:
          host_name: "{{ checkmk_hostname }}"
          folder: "/"
          attributes:
            ipaddress: "{{ ansible_host | default(inventory_hostname) }}"
      when: host_check.status == 404
      register: create_host_result

    # BƯỚC 3: DISCOVERY DÙ HOST MỚI HAY CŨ
    - name: Perform Service Discovery
      uri:
        url: "{{ checkmk_api }}/domain-types/service_discovery_run/actions/start/invoke"
        method: POST
        headers:
          Authorization: "{{ auth_header }}"
          Accept: application/json
          Content-Type: application/json
        body_format: json
        body:
          host_name: "{{ checkmk_hostname }}"
          mode: "refresh"
        status_code: [200, 302]

    # BƯỚC 4: LẤY ETAG ĐỂ KÍCH HOẠT
    - name: Get ETag for activation
      uri:
        url: "{{ checkmk_api }}/domain-types/activation_run/collections/pending_changes"
        method: GET
        headers:
          Authorization: "{{ auth_header }}"
          Accept: application/json
      register: pending_changes

    # BƯỚC 5: KÍCH HOẠT (CHỈ CHẠY 1 LẦN CHO CẢ PLAYBOOK)
    - name: Activate Changes
      uri:
        url: "{{ checkmk_api }}/domain-types/activation_run/actions/activate-changes/invoke"
        method: POST
        headers:
          Authorization: "{{ auth_header }}"
          If-Match: "{{ pending_changes.etag }}"
          Accept: application/json
          Content-Type: application/json
        body_format: json
        body:
          redirect: false
          sites: ["{{ checkmk_site }}"]
          force_foreign_changes: false
      run_once: true
