---
- name: Auto add hosts to Checkmk from AWX inventory
  hosts: all
  gather_facts: yes
  become: no

  vars:
    checkmk_api: "{{ checkmk_url }}/check_mk/api/1.0"

    checkmk_hostname: >-
      {{ inventory_hostname
         | lower
         | regex_replace('[^a-zA-Z0-9_.-]', '_') }}

    checkmk_ip: "{{ ansible_host | default(ansible_default_ipv4.address) }}"

  tasks:
    - name: Debug mapping
      debug:
        msg:
          awx_inventory_hostname: "{{ inventory_hostname }}"
          checkmk_hostname: "{{ checkmk_hostname }}"
          ip: "{{ checkmk_ip }}"

    # -------------------------------------------------
    # 1. Check host exists
    # -------------------------------------------------
    - name: Check if host exists in Checkmk
      uri:
        url: "{{ checkmk_api }}/objects/host_config/{{ checkmk_hostname }}"
        method: GET
        user: "{{ checkmk_user }}"
        password: "{{ checkmk_secret }}"
        force_basic_auth: yes
        validate_certs: no
        headers:
          Accept: application/json
        status_code: [200, 404]
      register: checkmk_host_check

    # -------------------------------------------------
    # 2. Create host
    # -------------------------------------------------
    - name: Add host to Checkmk (agent enabled)
      uri:
        url: "{{ checkmk_api }}/domain-types/host_config/collections/all"
        method: POST
        user: "{{ checkmk_user }}"
        password: "{{ checkmk_secret }}"
        force_basic_auth: yes
        validate_certs: no
        headers:
          Accept: application/json
          Content-Type: application/json
        body_format: json
        body:
          host_name: "{{ checkmk_hostname }}"
          folder: "{{ checkmk_folder }}"
          attributes:
            ipaddress: "{{ checkmk_ip }}"
            tag_agent: "cmk-agent"
      when: checkmk_host_check.status == 404

    # -------------------------------------------------
    # 3. Start service discovery (async)
    # -------------------------------------------------
    - name: Start service discovery
      uri:
        url: "{{ checkmk_api }}/domain-types/service_discovery_run/actions/start/invoke"
        method: POST
        user: automation
        password: "{{ checkmk_secret }}"
        force_basic_auth: true
        validate_certs: false
        headers:
          Accept: application/json
          Content-Type: application/json
        body_format: json
        body:
          host_name: "{{ checkmk_hostname }}"
          mode: refresh
        status_code: [200, 302, 303]

    - name: Wait 45 seconds for service discovery
      pause:
        seconds: 45
    # -------------------------------------------------
    # 4. Accept ALL discovered services (QUAN TRá»ŒNG)
    # -------------------------------------------------
    - name: Accept all discovered services
      uri:
        url: "{{ checkmk_api }}/objects/host_config/{{ checkmk_hostname }}/actions/accept-all-services/invoke"
        method: POST
        user: "{{ checkmk_user }}"
        password: "{{ checkmk_secret }}"
        force_basic_auth: yes
        validate_certs: no
        headers:
          Accept: application/json
          Content-Type: application/json
        body_format: json
        body:
          mode: refresh
        status_code: [200, 204, 409]

    # -------------------------------------------------
    # 5. Activate changes (FINAL)
    # -------------------------------------------------
    - name: Activate changes
      uri:
        url: "{{ checkmk_api }}/domain-types/activation_run/actions/activate-changes/invoke"
        method: POST
        user: "{{ checkmk_user }}"
        password: "{{ checkmk_secret }}"
        force_basic_auth: yes
        validate_certs: no
        headers:
          Accept: application/json
          Content-Type: application/json
        body_format: json
        body:
          sites:
            - "{{ checkmk_site }}"
          force_foreign_changes: false
      status_code: [200, 204, 422]
